#!/usr/bin/env bash
# Install Contour (AI, Marimo, local models). Then run: ./Contour
set -e
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$DIR"

usage() {
  echo "Usage: $0 [--system] [--force]"
  echo "  --system   Install into system Python 3.14 (default: install into .venv)"
  echo "  --force    Reinstall/upgrade even if already installed"
  echo ""
  echo "Then run: Contour  (from anywhere, after opening a new terminal or sourcing your shell rc)"
}

USE_SYSTEM=
FORCE=
while [[ $# -gt 0 ]]; do
  case "$1" in
    --system) USE_SYSTEM=1; shift ;;
    --force)  FORCE=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
done

PY314="$(command -v python3.14 2>/dev/null)"
if [[ -z "$PY314" ]]; then
  echo "Contour requires Python 3.14 or newer. Install it and ensure python3.14 is on your PATH." >&2
  exit 1
fi
PY_MINOR="$("$PY314" -c "import sys; print(sys.version_info.minor)" 2>/dev/null)"
if [[ -z "$PY_MINOR" ]] || [[ "$PY_MINOR" -lt 14 ]]; then
  echo "Contour requires Python 3.14+. python3.14 reports minor version $PY_MINOR." >&2
  exit 1
fi

EXTRAS_BASE="pydantic-ai,llama-cpp,marimo"
EXTRAS_FULL="${EXTRAS_BASE},git"

do_install() {
  local py="$1"
  local ex="$2"
  if command -v uv &>/dev/null; then
    uv pip install --python "$py" -e ".[$ex]" -q
  else
    "$py" -m pip install -e ".[$ex]" -q
  fi
}

do_install_system() {
  if command -v uv &>/dev/null; then
    uv pip install --python "$PY314" --system -e ".[$1]" -q
  else
    "$PY314" -m pip install -e ".[$1]" -q
  fi
}

# Try full install (with pygit2); if that fails, install dulwich and project without git extra.
try_install_with_git_fallback() {
  local py="$1"
  if do_install "$py" "$EXTRAS_FULL"; then
    return 0
  fi
  echo "pygit2 unavailable (e.g. no libgit2); using dulwich for git support." >&2
  if command -v uv &>/dev/null; then
    uv pip install --python "$py" dulwich -q
  else
    "$py" -m pip install dulwich -q
  fi
  do_install "$py" "$EXTRAS_BASE"
}

try_install_system_with_git_fallback() {
  if do_install_system "$EXTRAS_FULL"; then
    return 0
  fi
  echo "pygit2 unavailable (e.g. no libgit2); using dulwich for git support." >&2
  if command -v uv &>/dev/null; then
    uv pip install --python "$PY314" --system dulwich -q
  else
    "$PY314" -m pip install dulwich -q
  fi
  do_install_system "$EXTRAS_BASE"
}

if [[ -n "$USE_SYSTEM" ]]; then
  if [[ -z "$FORCE" ]] && "$PY314" -c "import thonny" &>/dev/null; then
    echo "Already installed (system). Use --force to reinstall."
    exit 0
  fi
  echo "Installing Contour into system Python 3.14..."
  try_install_system_with_git_fallback
  echo "Done. Run: Contour  (or: python3.14 -m thonny)"
else
  VENV_PY="$DIR/.venv/bin/python"
  if [[ ! -x "$VENV_PY" ]]; then
    echo "Creating .venv and installing Contour..."
    if command -v uv &>/dev/null; then
      uv venv --python "$PY314" "$DIR/.venv"
    else
      "$PY314" -m venv "$DIR/.venv"
    fi
    try_install_with_git_fallback "$VENV_PY"
    echo "Done."
  elif [[ -n "$FORCE" ]]; then
    echo "Reinstalling Contour in .venv..."
    try_install_with_git_fallback "$VENV_PY"
    echo "Done."
  else
    echo "Already installed (.venv). Use --force to reinstall."
    exit 0
  fi
fi

# Add repo to PATH so you can run Contour from anywhere
CONTOUR_PATH_LINE="export PATH=\"$DIR:\$PATH\""
for rc in ~/.zshrc ~/.bashrc; do
  if [[ -f "$rc" ]] && ! grep -Fq "$DIR" "$rc" 2>/dev/null; then
    echo "" >> "$rc"
    echo "# Contour (run from anywhere)" >> "$rc"
    echo "$CONTOUR_PATH_LINE" >> "$rc"
    echo "Added $DIR to PATH in $rc â€” open a new terminal or run: source $rc" >&2
  fi
done
echo "Run Contour from anywhere (in a new terminal or: source ~/.zshrc)" >&2
